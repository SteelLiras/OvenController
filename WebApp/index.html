<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	
    <link href="css/metro.min.css" rel="stylesheet">
	<link href="css/metro-icons.min.css" rel="stylesheet">
	
    <script src="js/jquery.min.js"></script>
    <script src="js/metro.min.js"></script>
	
	<script src="js/Helpers.js"></script>
	<script src="js/Server.js"></script>
	<script src="js/PointGroup.js"></script>
	<script src="js/PIDPlot.js"></script>
	<script src="js/OvenPlot.js"></script>
	<script src="js/PlotRenderer.js"></script>
	<script src="js/PlotManager.js"></script>
	
	<script type="text/javascript">
		var enforceSlope;
	
		var serverAddress = "http://192.168.1.15";
		var server, ovenPlot, plotRenderer, plotManager; 

		function Initialize()
		{
			Helpers.Initialize("canvas");
			
			server = new Server(serverAddress);
			ovenPlot = new OvenPlot();
		
			plotRenderer = new PlotRenderer("canvas", ovenPlot);
			UpdateScale();
			
			plotManager = new PlotManager("canvas", ovenPlot, plotRenderer);
		}
		
		function StartOven()
		{
			server.SendConfig(enforceSlope, 
			function(success) 
			{
				if (!success)
				{
					alert("Failed to send configuration to server.");
					return;
				}
				
				server.SendData(ovenPlot.TopLampPlot.userInputGroup, ovenPlot.BottomLampPlot.userInputGroup,
				function(success)
				{
					if (!success)
					{
						alert("Failed to send data to server.");
						return;
					}
					
					GetTemperature();
				});
			});
		}
		
		function GetTemperature()
		{
			server.GetTemperature(function(time, tempTop, tempBottom)
			{
				ovenPlot.AddReadout(time, tempTop, tempBottom);
			});
			
			//TODO Configurable intervals
			if (server.isOvenRunning)
				SetTimeout(GetTemperature, 500);
		}
		
		function UpdateScale()
		{
			var scaleX = parseInt(document.getElementById("scaleX").value);
			var scaleY = parseInt(document.getElementById("scaleY").value);
			
			plotRenderer.UpdateScale(scaleX, scaleY);
		}
		
		function AddPoint()
		{
			var x = parseInt(document.getElementById("newPointX").value);
			var y = parseInt(document.getElementById("newPointY").value);
			
			plotManager.AddPoint(x, plotRenderer.limitY - y);
		}
		
		function Stop()
		{
			server.Stop(function(success) { if (!success) alert("There is no stopping!"); })
		}
		
		function ClearAll()
		{
			if (!server.isOvenRunning)
			{
				ovenPlot.ClearAll();
				plotRenderer.UpdateRenderer();
			}
		}
		
		function ClearReadout()
		{
			if (!server.isOvenRunning)
			{
				ovenPlot.ClearReadout();
				plotRenderer.UpdateRenderer();
			}
		}
	</script>
	
	<style type="text/css">
		canvas { 
			margin:0; 
			padding:0;
			display:block;
		} 
		
		html, body {
			width:100%;
			height:100%;
		} 
	</style>
</head>
<body onload="Initialize()">
    <div data-role="dialog" id="dialog" class="padding20" data-close-button="true">
        <h1>Settings</h1>
		Snap to grid
		<label class="switch" for="snapping">
			<input onclick="plotManager.snapping = !plotManager.snapping;" checked id="snapping" type="checkbox">
			<span class="check"></span>
		</label>
		Enforce slope
		<label class="switch">
			<input onclick="enforceSlope = !enforceSlope;" checked type="checkbox">
			<span class="check"></span>
		</label>
    </div>
    <script>
        function showDialog(id)
		{
            var dialog = $(id).data('dialog');
            dialog.open();
        }
    </script>
	<canvas id="canvas"></canvas>
	<div data-role="charm" data-position="bottom" id="free-position-charm" id="settingsPanel">
		<div class="grid" style="margin-right:25px;">
            <div class="row cells3">
                <div class="cell">
				   <div class="panel alert">
						<div class="heading">
							<span class="icon mif-target"></span>
							<span class="title">Precise Data Input</span>
						</div>
						<div class="content" style="height: 100px;padding:25px;">
							<div style="margin:auto;width:500px;">
								<div class="input-control text">
									<input id="newPointX" type="text" placeholder="X">
								</div>
								<div class="input-control text">
									<input id="newPointY" type="text" placeholder="Y">
								</div>
								<button class="button rounded" onclick="AddPoint()">Add Point</button>
							</div>
						</div>
					</div>
				</div>
				<div class="cell">
					<div class="panel alert">
						<div class="heading">
							<span class="icon mif-microscope"></span>
							<span class="title">Chart Scale</span>
						</div>
						<div class="content" style="height: 100px;padding:5px;">
							<div class="content"  style="margin:auto;height: 100px;">
								Units Horizontal:
								<div class="input-control text">
									<input id="scaleX" type="text" onchange="UpdateScale()" value="600">
								</div>
								Units Vertical:
								<div class="input-control text">
									<input id="scaleY" type="text" onchange="UpdateScale()" value="300">
								</div>			
							</div>
						</div>
					</div>
				</div>
				<div class="cell">
					<div class="panel alert">
						<div class="heading">
							<span class="icon mif-cog"></span>
							<span class="title">Options</span>
						</div>
						<div class="content"  style="height: 100px;padding:25px;">
							<div style="margin:auto;width:600px;">
								<button class="button rounded" onclick="ClearAll()">Clear All</button>
								<button class="button rounded" onclick="ClearReadout()">Clear Readout</button>
								<button class="button rounded" onclick="showDialog('#dialog')">Settings</button>
								<button class="button rounded" onclick="Stop()">Stop</button>
								<button class="large-button button danger block-shadow-danger text-shadow lighten loading-cube" onclick="StartOven()">Start</button>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="cell">
					<div class="panel alert collapsed" data-role="panel">
						<div class="heading">
							<span class="icon mif-cabinet"></span>
							<span class="title">Plots</span>
						</div>
						<div class="content padding10">
							<div class="listview list-type-icons" data-role="listview" id="groupList" data-on-list-click="plotManager.selectedLamp = parseInt(list.find('.list-title').text());">
								<div class="list active">
									<div style="background-color: green;" class="list-icon"></div>
									<span class="list-title">0</span>
								</div>
								<div class="list">
									<div style="background-color: blue;" class="list-icon"></div>
									<span class="list-title">1</span>
								</div>
							</div><br />
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<button style="position: absolute;bottom: 0;right: 0;" class="button rounded bg-dark" onclick="showMetroCharm('#free-position-charm', 'bottom')">
		<span class="mif-arrow-up mif-2x fg-white"></span>
	</button>
</body>
</html>